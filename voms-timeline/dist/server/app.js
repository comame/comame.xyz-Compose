!function(e){var t={};function o(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=2)}([function(e,t){e.exports=require("path")},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(8)),s=o(0);t.dotenv=Object.fromEntries(i.default.readFileSync(s.resolve(__dirname,"../../.env"),{encoding:"utf8"}).split("\n").map(e=>e.split("=")))},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(0)),s=n(o(3)),r=o(4),u=o(5),a=o(10),d=o(16),l=s.default();let c;l.use((e,t,o)=>{let n="";e.on("data",e=>{n+="string"==typeof e?e:e.toString("utf8")}),e.on("end",()=>{e.body=n,o()})}),l.get("**",s.default.static(i.default.resolve(__dirname,"../front"))),l.all("/sub/hook",async(e,t)=>{const o=await u.websubExpressHandler(e,t,c);if(!o)return;const n=await a.fetchVideo(o);n&&await d.cacheResponse(c,[n])}),l.get("/sub/logs",async(e,t)=>{const o=await c.collection("subs-log").find().sort({time:-1}).limit(100).toArray();t.send(JSON.stringify(o,void 0,2))}),l.get("/api/videos",async(e,t)=>{const{videos:o,lastUpdated:n}=await d.getCached(c);t.send({kind:"voms-timeline.comame.xyz#videosResponse",items:o,lastUpdated:new Date(n).toISOString()})}),r.MongoClient.connect("mongodb://mongo:27017",{useUnifiedTopology:!0},(e,t)=>{if(e)throw e;c=t.db("voms-timeline"),l.listen(80,()=>{console.log("LISTEN")})})},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mongodb")},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(6)),s=o(7),r=o(1),u=o(9);t.websubExpressHandler=async function(e,t,o){var n,a,d,l,c;const f=Object.fromEntries(null!==(a=null===(n=e.originalUrl.split("?")[1])||void 0===n?void 0:n.split("&").map(e=>e.split("=")))&&void 0!==a?a:[]),p=async({queryObj:t,subscribeObject:n,result:i,rawBody:s=""})=>{await o.collection("subs-log").insertOne({time:Date.now(),req:{url:e.originalUrl,query:Object.fromEntries(Object.entries(null!=t?t:{}).map(e=>[e[0].replace(/\./g,"_"),e[1]])),method:e.method,body:n,headers:e.headers,result:i,rawBody:s}})};if("subscribe"==f["hub.mode"]){if(Object.entries(u.channels).map(e=>e[1]).map(e=>("https://www.youtube.com/xml/feeds/videos.xml?channel_id="+e).replace(/\?/g,"%3F").replace(/\=/g,"%3D")).includes(f["hub.topic"])){const e=f["hub.challenge"];t.send(e),await p({queryObj:f,result:200})}else t.sendStatus(404),await p({queryObj:f,result:404});return}if("unsubscribe"==f["hub.mode"])return t.sendStatus(404),void await p({queryObj:f,result:404});if("denied"==f["hub.mode"])return t.send(),void await p({queryObj:f,result:200});if(!0!==s.validate(e.body)){const o=s.validate(e.body);return console.error("VALIDATE ERROR",o),t.status(500).send("error"),void await p({subscribeObject:e.body,result:500,rawBody:e.body})}const b=r.dotenv.WEBSUB_HUB_SECRET,v=i.default.createHmac("sha1",b).update(e.body).digest("hex"),y=null===(d=e.header("x-hub-signature"))||void 0===d?void 0:d.slice("sha1=".length);if(v!=y)return console.error("Invalid digest request","wants: "+v,"got: "+y),t.send("ok"),void await p({subscribeObject:e.body,result:200500,rawBody:e.body});t.send("ok");const m=s.parse(e.body),h=null===(c=null===(l=m.feed)||void 0===l?void 0:l.entry)||void 0===c?void 0:c["yt:videoId"];return await p({subscribeObject:m,result:200,rawBody:e.body}),h}},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("fast-xml-parser")},function(e,t){e.exports=require("fs")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.channels={"天野ピカミィ":"UCajhBT4nMrg3DLS-bLL2RCg","緋笠トモシカ":"UC3vzVK_N_SUVKqbX69L_X4g","磁富モノエ":"UCaFhsCKSSS821N-EcWmPkUQ"}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(11),i=o(12),s=o(14),r=o(1),u=o(15);t.fetchVideo=async function(e){const t={part:["id","snippet","liveStreamingDetails"],id:e,key:r.dotenv.GOOGLE_API_KEY},o=u.buildUrlQuery(s.youtube.videos,{...t,part:t.part.join(",")}),a=await i.fetch(o),d=await a.json();if(!n.isVideoAPIResponse(d))throw"ERROR";return d.items[0]}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isVideoAPIResponse=function(e){return"object"==typeof e&&"youtube#videoListResponse"==e.kind}},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(13));t.fetch=async function(e,t){return new Promise((o,n)=>{const r=i.default.request(e,null!=t?t:{},e=>{let t="";e.on("data",e=>{t+="string"==typeof e?e:new TextDecoder("utf-8").decode(e)}),e.on("end",()=>{const n={};for(const t of Object.keys(e.headers)){const o=e.headers[t];void 0!==o&&(Array.isArray(o)?n[t]=o.join(" "):n[t]=o)}o(new s(n,e.statusCode,e.url,t))})});r.on("error",e=>{n(e)}),r.end()})};class s{constructor(e,t,o,n){this.headers=e,this.status=t,this.url=o,this.ok=200<=t&&t<300,this.json=async()=>JSON.parse(n),this.text=async()=>n}}t.Response=s},function(e,t){e.exports=require("https")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.youtube={search:"https://www.googleapis.com/youtube/v3/search",activities:"https://www.googleapis.com/youtube/v3/activities",videos:"https://www.googleapis.com/youtube/v3/videos"},t.self={videos:"/api/videos"}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildUrlQuery=function(e,t){return e+"?"+Object.keys(t).map(e=>{const o=t[e];if(void 0!==o)return encodeURIComponent(e)+"="+encodeURIComponent(o)}).filter(e=>void 0!==e).join("&")}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(17);t.cacheResponse=async function(e,t){const o=e.collection("metadata");await o.updateOne({},{$set:{lastUpdated:(new Date).getTime()}},{upsert:!0});const i=e.collection("videos");await Promise.all(t.map(e=>i.updateOne({_id:e.id},{$set:{_id:e.id,time:n.getVideoTime(e).getTime(),item:e,update:Date.now()}},{upsert:!0})))},t.getCached=async function(e,t=50){var o;const n=e.collection("metadata"),i=e.collection("videos"),s=await n.findOne({}),r=(await i.find().sort("time",-1).limit(t).toArray()).map(e=>e.item);return{lastUpdated:null!==(o=null==s?void 0:s.lastUpdated)&&void 0!==o?o:Date.now(),videos:r}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(18);t.getVideoTime=function(e){var t,o,i;return(null===(t=e.liveStreamingDetails)||void 0===t?void 0:t.actualEndTime)?n.asDate(e.liveStreamingDetails.actualEndTime):(null===(o=e.liveStreamingDetails)||void 0===o?void 0:o.scheduledStartTime)?n.asDate(e.liveStreamingDetails.scheduledStartTime):n.asDate(null===(i=e.snippet)||void 0===i?void 0:i.publishedAt)}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asDate=function(e){return new Date(e)}}]);
//# sourceMappingURL=app.js.map